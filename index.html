<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›»å­è¯çµ¡ç°¿ - 6ç­ç´š+å…¨å‚™ä»½ç‰ˆ</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body {
            font-family: "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", Arial, sans-serif;
            font-weight: bold;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            padding: 20px;
            margin: 0;
            padding-top: 140px; /* ä¸Šæ–¹é ç•™ç©ºé–“ */
        }

        /* --- A4 å®¹å™¨ --- */
        .page-container {
            width: 250mm;
            background: white;
            padding: 25px 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border-radius: 10px;
            position: relative;
            background-color: #ffffff;
        }

        /* --- é ‚éƒ¨å€åŸŸ (ç­ç´š & æ—¥æœŸ) --- */
        .class-row {
            display: flex;
            align-items: flex-end;
            margin-bottom: 10px;
            color: #0066cc;
            font-size: 20px;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 20px;
            padding-bottom: 5px;
            color: #0066cc;
            font-size: 20px;
        }

        .stack-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1.2;
            white-space: nowrap;
        }

        .stack-label .zh { font-size: 24px; margin-bottom: 2px; }
        .stack-label .en { font-size: 14px; font-weight: normal; }

        .class-row .stack-label, 
        .date-title-group .stack-label { 
            align-items: flex-start; 
            margin-right: 15px;
        }

        .date-title-group { display: flex; align-items: flex-end; margin-right: 20px; }
        
        .date-inputs-group {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            flex-grow: 1;
            padding-left: 20px;
        }

        .weekday-group { display: flex; align-items: flex-end; gap: 10px; }

        /* --- é¡¯çœ¼è¼¸å…¥æ¡† --- */
        .highlight-input {
            border: none;
            border-bottom: 3px solid #0066cc;
            text-align: center;
            background: transparent;
            font-family: "Patrick Hand", "æ¨™æ¥·é«”", "KaiTi", cursive;
            font-size: 40px; 
            font-weight: 900;
            color: #000000;
            padding: 0;
            line-height: 1.2;
            margin-bottom: 2px;
            height: 50px; 
        }

        .input-month, .input-day { width: 80px; }
        .input-weekday { width: 180px; text-align: left; padding-left: 10px;} 
        .input-classname { width: 400px; text-align: left; padding-left: 10px; }

        /* --- è¡¨æ ¼æ¨£å¼ --- */
        .main-table {
            width: 100%;
            border-collapse: collapse;
            border: 3px solid #2d89ef;
            border-radius: 15px 15px 0 0;
            overflow: hidden;
            margin-top: 10px;
            table-layout: fixed;
        }

        .main-table th, .main-table td {
            border: 2px solid #2d89ef;
            padding: 5px;
            vertical-align: middle;
        }

        .section-header {
            background-color: #dbeeff;
            color: #0050a0;
            text-align: center;
            font-size: 24px;
            padding: 10px !important;
        }

        .sub-header {
            background-color: #dbeeff;
            color: #0050a0;
            font-size: 20px;
            text-align: center;
            width: 50%;
        }

        .label-cell {
            background-color: #dbeeff;
            color: #0050a0;
            width: 18%;
            text-align: center;
            font-size: 19px;
            white-space: normal;
            line-height: 1.2;
        }

        .textbook-selector {
            cursor: pointer;
            padding: 5px 8px;
            margin: 0 1px;
            border-radius: 12px;
            transition: all 0.2s;
            border: 3px solid transparent;
            display: inline-block;
            font-size: 18px;
        }

        .textbook-selector:hover { background-color: rgba(255, 255, 255, 0.5); }

        .textbook-selector.active {
            border: 3px solid #e60000;
            color: #e60000;
            font-weight: 900;
            background-color: rgba(255, 255, 255, 0.8);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .input-cell {
            background-color: white;
            padding: 0 !important;
            height: 65px; 
            vertical-align: top; 
            position: relative;
        }

        /* --- è¼¸å…¥æ¡†è¨­å®š --- */
        .table-input, .homework-area, .signature-input {
            width: 100%;
            border: none;
            outline: none;
            font-family: "Patrick Hand", "æ¨™æ¥·é«”", "KaiTi", cursive;
            font-size: 34px; 
            font-weight: 900;
            color: #000000;
            box-sizing: border-box;
            background: transparent;
        }

        .table-input { 
            height: 100%; 
            padding: 0 10px;
            display: flex;
            align-items: center; 
        }

        .homework-area {
            height: 240px;
            resize: none;
            padding: 0 10px;
            line-height: 60px; 
            background-image: repeating-linear-gradient(transparent, transparent 58px, #eee 59px, transparent 60px);
            background-attachment: local;
            padding-top: 5px; 
        }

        .signature-header-row td {
            height: auto;
            vertical-align: top;
            padding: 8px;
            font-size: 18px;
            color: #0050a0;
            background-color: #dbeeff;
            text-align: center;
        }
        
        .parent-note {
            display: block;
            font-size: 14px;
            color: #cc0000;
            margin-top: 5px;
            font-weight: bold;
            line-height: 1.4;
        }

        .signature-input {
            height: 100px;
            font-size: 34px;
            text-align: center;
            resize: none;
            line-height: 48px;
            padding-top: 5px;
        }

        /* --- é‡é»æé†’å€åŸŸ --- */
        .important-notice {
            margin-top: 15px;
            border: 4px dashed #ff4444;
            background-color: #fffbdd;
            padding: 10px 20px;
            border-radius: 10px;
            color: #d60000;
        }

        .important-notice h3 {
            margin: 0 0 5px 0;
            font-size: 22px;
            font-weight: 900;
            text-align: center;
            border-bottom: 2px solid #ffcccc;
            padding-bottom: 5px;
        }

        .notice-list {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .notice-list li {
            font-size: 20px;
            font-weight: 900;
            margin: 5px 10px;
        }

        /* --- å·¥å…·åˆ— --- */
        .toolbar-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 999;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            background: #333;
            padding: 8px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .toolbar-secondary {
            background: #444;
            padding: 5px 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            border-top: 1px solid #555;
            flex-wrap: wrap;
        }

        .mode-group {
            display: flex;
            background: #555;
            border-radius: 5px;
            padding: 2px;
            margin-right: 10px;
        }

        .mode-btn {
            padding: 8px 15px;
            border: none;
            background: transparent;
            color: #aaa;
            cursor: pointer;
            font-weight: bold;
            font-family: "Microsoft JhengHei", sans-serif;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background: #ffc107;
            color: #000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .btn {
            padding: 6px 12px;
            background: #666;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-family: "Microsoft JhengHei", sans-serif;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn:hover { background: #888; }
        .btn-green { background: #28a745; }
        .btn-green:hover { background: #218838; }
        .btn-blue { background: #0056b3; }
        .btn-blue:hover { background: #004494; }
        .btn-red { background: #c00; }
        .btn-red:hover { background: #a00; }
        .btn-orange { background: #fd7e14; }
        .btn-orange:hover { background: #e36a00; }
        .btn-purple { background: #6f42c1; }
        .btn-purple:hover { background: #59359a; }
        .btn-purple-dark { background: #4a2c82; border: 2px solid #a885eb; }
        .btn-purple-dark:hover { background: #3b2368; }
        
        /* å‚™ä»½æŒ‰éˆ•æ¨£å¼ */
        .btn-cyan { background: #17a2b8; }
        .btn-cyan:hover { background: #138496; }

        .btn:disabled { background: #999 !important; cursor: not-allowed; }
        
        /* ç­ç´šå¡ç‰‡æ¨£å¼ */
        .slot-card {
            display: flex;
            flex-direction: column;
            background: #555;
            padding: 4px;
            border-radius: 5px;
            margin: 0 2px;
            width: 110px;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .slot-card.active-slot {
            border-color: #ffc107;
            background: #666;
            box-shadow: 0 0 8px rgba(255, 193, 7, 0.4);
        }

        .slot-name-input {
            width: 100%;
            background: #333;
            border: 1px solid #777;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 13px;
            text-align: center;
            margin-bottom: 3px;
            box-sizing: border-box;
        }
        
        .slot-name-input:focus {
            background: #000;
            border-color: #ffc107;
            outline: none;
        }

        .slot-btn {
            width: 100%;
            padding: 3px;
            font-size: 12px;
            cursor: pointer;
            border: none;
            border-radius: 3px;
            background: #777;
            color: white;
            font-weight: bold;
        }
        
        .slot-btn:hover { background: #888; }
        .slot-card.active-slot .slot-btn {
            background: #ffc107;
            color: black;
        }

        .toolbar-label {
            color: #ccc;
            font-size: 14px;
            margin-right: 10px;
        }

        /* æª”æ¡ˆä¸Šå‚³ input éš±è— */
        #file-input { display: none; }

        @media print {
            .toolbar-container { display: none; }
            body { padding: 0; background: white; -webkit-print-color-adjust: exact; margin-top: 0; }
            .page-container { box-shadow: none; width: 100%; padding: 0; margin: 0 auto; }
        }

        /* --- æˆªåœ–å°ˆç”¨æ¨£å¼ --- */
        .snapshot-text-div {
            font-family: "Patrick Hand", "æ¨™æ¥·é«”", "KaiTi", cursive;
            font-weight: 900;
            color: #000000;
            white-space: pre-wrap; 
            overflow: visible; 
            display: flex;
            align-items: center; 
        }
        
        .snapshot-date {
            font-size: 40px;
            border-bottom: 3px solid #0066cc;
            text-align: center;
            justify-content: center;
            height: 50px;
            line-height: 1.2;
            padding-top: 5px; 
        }

        .snapshot-table-input {
            font-size: 34px;
            padding: 0 10px;
            height: 100%;
            align-items: center;
            line-height: 1.2;
        }

        .snapshot-homework {
            font-size: 34px;
            line-height: 60px; 
            padding: 5px 10px;
            display: block; 
            min-height: 240px;
        }

        .snapshot-signature {
            font-size: 34px;
            text-align: center;
            justify-content: center;
            padding-top: 10px;
            line-height: 1.4;
            display: block; 
        }

        /* éš±è—å…ƒç´ ç”¨ */
        .hidden { display: none !important; }

    </style>
</head>
<body>

    <div class="toolbar-container">
        <div class="toolbar">
            <div class="mode-group">
                <button class="mode-btn active" id="btn-mode-ap" onclick="setMode('AP')">AP</button>
                <button class="mode-btn" id="btn-mode-kindy" onclick="setMode('KINDY')">å¹¼å…’</button>
            </div>
            
            <button class="btn btn-purple-dark" onclick="saveToCurrentSlot()" id="btn-main-save" title="å„²å­˜åˆ°ç›®å‰é¸å–çš„ç­ç´š">
                ğŸ’¾ å„²å­˜ç•¶å‰ç­ç´š
            </button>
            
            <div style="width: 10px;"></div>

            <button class="btn" onclick="fillDate()">ğŸ“… ä»Šå¤©</button>
            <button class="btn btn-green" onclick="copyText()">ğŸ“‹ è¤‡è£½</button>
            <button class="btn btn-blue" onclick="generateImage(this)">ğŸ“· æˆªåœ–</button>
            <button class="btn btn-red" onclick="clearAll()">ğŸ—‘ï¸ æ¸…ç©º</button>
            <button class="btn btn-orange" id="btn-undo" onclick="undoClear()" style="display:none;">â†©ï¸ å¾©åŸ</button>
            
            <div style="width: 10px; border-right: 1px solid #555; height: 30px;"></div>
            
            <button class="btn btn-cyan" onclick="exportData()">ğŸ“¥ å‚™ä»½</button>
            <button class="btn btn-cyan" onclick="document.getElementById('file-input').click()">ğŸ“¤ é‚„åŸ</button>
            <input type="file" id="file-input" accept=".json" onchange="importData(this)">
        </div>
        
        <div class="toolbar-secondary" id="slots-container">
            </div>
    </div>

    <div class="page-container" id="capture-area">
        
        <div class="class-row">
            <div class="stack-label">
                <span class="zh">ç­ç´š :</span>
                <span class="en">(Class)</span>
            </div>
            <input type="text" class="highlight-input input-classname" id="class-name">
        </div>

        <div class="header-row">
            <div class="date-title-group">
                <div class="stack-label">
                    <span class="zh">æ—¥æœŸ :</span>
                    <span class="en">(Date)</span>
                </div>
            </div>
            <div class="date-inputs-group">
                <input type="text" class="highlight-input input-month" id="month">
                <div class="stack-label">
                    <span class="zh">æœˆ</span>
                    <span class="en">(Month)</span>
                </div>
                <div style="width: 20px;"></div>
                <input type="text" class="highlight-input input-day" id="day">
                <div class="stack-label">
                    <span class="zh">æ—¥</span>
                    <span class="en">(Day)</span>
                </div>
            </div>
            <div class="weekday-group">
                <div class="stack-label">
                    <span class="zh">æ˜ŸæœŸ :</span>
                    <span class="en">(Day of the Week)</span>
                </div>
                <input type="text" class="highlight-input input-weekday" id="weekday">
            </div>
        </div>

        <table class="main-table">
            <tr>
                <td colspan="4" class="section-header">Today's Lesson ä»Šæ—¥èª²ç¨‹</td>
            </tr>

            <tr>
                <td class="label-cell">
                    <div id="label-book-ap">
                        <span class="textbook-selector" id="sel-bj" onclick="toggleTextbook('sel-bj')">Big Jump</span>
                        /
                        <span class="textbook-selector" id="sel-clil" onclick="toggleTextbook('sel-clil')">CLIL</span>
                    </div>
                    <div id="label-book-kindy" class="hidden">
                        <span class="textbook-selector" id="sel-sb" onclick="toggleTextbook('sel-sb')">Student Book</span>
                    </div>
                </td>
                <td class="input-cell"><input type="text" class="table-input save-target" data-id="bj"></td>
                
                <td class="label-cell">
                    <div id="group-ph-ap">
                        <span class="textbook-selector" id="sel-ph" onclick="toggleTextbook('sel-ph')">Phonics</span>
                        /
                        <span class="textbook-selector" id="sel-br" onclick="toggleTextbook('sel-br')">Better Reader</span>
                    </div>
                    <div id="group-ph-kindy" class="hidden">
                        Stem/CLIL
                    </div>
                </td>
                <td class="input-cell"><input type="text" class="table-input save-target" data-id="ph"></td>
            </tr>

            <tr>
                <td class="label-cell">
                    <div id="label-wr-container">
                        <span id="label-wr">Writing</span>
                    </div>
                </td>
                <td class="input-cell"><input type="text" class="table-input save-target" data-id="wr"></td>
                <td class="label-cell">Other</td>
                <td class="input-cell"><input type="text" class="table-input save-target" data-id="ot"></td>
            </tr>

            <tr>
                <td colspan="2" class="sub-header">Homework å›å®¶ä½œæ¥­</td>
                <td colspan="2" class="sub-header" id="header-quiz">Quiz/ Test for Next Time ä¸‹æ¬¡è€ƒè©¦</td>
            </tr>

            <tr>
                <td colspan="2" class="input-cell" style="vertical-align: top;">
                    <textarea class="homework-area save-target" data-id="hw" placeholder="Input here..."></textarea>
                </td>
                <td colspan="2" class="input-cell" style="vertical-align: top;">
                    <textarea class="homework-area save-target" data-id="qz" placeholder="Input here..."></textarea>
                </td>
            </tr>

            <tr class="signature-header-row">
                <td colspan="2">
                    <div class="signature-text">Teacher's Signature è€å¸«ç°½å</div>
                </td>
                <td colspan="2">
                    <div class="signature-text">
                        Parent's Signature å®¶é•·ç°½å<br>
                        <span class="parent-note">å¯¶è²å®Œæˆè¤‡ç¿’å¾Œï¼Œè«‹åœ¨è¯çµ¡ç°¿ç›¸å°æ‡‰çš„æ—¥æœŸä¸Šç°½åã€‚è¬è¬ã€‚</span>
                    </div>
                </td>
            </tr>
            
            <tr>
                <td colspan="2" class="input-cell">
                    <textarea class="signature-input save-target" data-id="sign_teacher" placeholder=""></textarea>
                </td>
                <td colspan="2" class="input-cell">
                    <textarea class="signature-input save-target" data-id="sign_parent" placeholder=""></textarea>
                </td>
            </tr>
        </table>

        <div class="important-notice">
            <h3 id="footer-notice-title">è«‹å®¶é•·æé†’å¯¶è²è¦åˆ©ç”¨é»è®€ç­†åšè¤‡ç¿’å“¦ï¼</h3>
            <ul class="notice-list" id="footer-list">
                </ul>
        </div>
    </div>

    <script>
        // --- ç‹€æ…‹ç®¡ç† ---
        let currentMode = 'AP'; // 'AP' or 'KINDY'
        const SELECTOR_IDS = ['sel-bj', 'sel-clil', 'sel-sb', 'sel-ph', 'sel-br'];
        
        // æ–°å¢ï¼šç­ç´šç®¡ç†
        let activeSlotId = 1; // é è¨­ç•¶å‰ç­ç´š ID
        const TOTAL_SLOTS = 6;

        // --- å„²å­˜èˆ‡é‚è¼¯ ---
        const inputs = document.querySelectorAll('input, textarea');

        window.addEventListener('load', () => {
            // åˆå§‹åŒ–ç­ç´šå·¥å…·åˆ—
            initSlotToolbar();

            // é‚„åŸè¼¸å…¥æ¡†å…§å®¹ (é è¨­è¼‰å…¥æœ€å¾Œä¸€æ¬¡æ“ä½œçš„å…§å®¹ï¼Œæˆ–ä¿æŒä¸Šæ¬¡ç‹€æ…‹)
            inputs.forEach(input => {
                const key = input.id || input.getAttribute('data-id');
                if (key) {
                    const savedValue = localStorage.getItem('contact_book_v2_' + key);
                    if (savedValue) input.value = savedValue;
                }
            });
            
            // é‚„åŸæ›¸æœ¬é¸æ“‡
            SELECTOR_IDS.forEach(id => restoreTextbookSelection(id));

            // é‚„åŸæ¨¡å¼ï¼Œé è¨­AP
            const savedMode = localStorage.getItem('contact_book_mode');
            if(savedMode) {
                setMode(savedMode);
            } else {
                setMode('AP'); // init
            }

            // è®€å–ä¸Šæ¬¡æœ€å¾Œæ“ä½œçš„ Slot ID
            const lastActive = localStorage.getItem('cb_last_active_slot');
            if(lastActive) {
                activeSlotId = parseInt(lastActive);
                updateSlotVisuals();
            }
        });

        inputs.forEach(input => {
            input.addEventListener('input', () => {
                const key = input.id || input.getAttribute('data-id');
                if (key) {
                    localStorage.setItem('contact_book_v2_' + key, input.value);
                }
            });
        });

        function toggleTextbook(id) {
            const el = document.getElementById(id);
            el.classList.toggle('active');
            const isSelected = el.classList.contains('active');
            localStorage.setItem('contact_book_v2_select_' + id, isSelected);
        }

        function restoreTextbookSelection(id) {
            const savedState = localStorage.getItem('contact_book_v2_select_' + id);
            if (savedState === 'true') {
                const el = document.getElementById(id);
                if(el) el.classList.add('active');
            } else {
                const el = document.getElementById(id);
                if(el) el.classList.remove('active');
            }
        }

        // --- æ¨¡å¼åˆ‡æ›é‚è¼¯ ---
        function setMode(mode) {
            currentMode = mode;
            localStorage.setItem('contact_book_mode', mode);

            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.getElementById('btn-mode-ap').classList.remove('active');
            document.getElementById('btn-mode-kindy').classList.remove('active');
            if (mode === 'AP') {
                document.getElementById('btn-mode-ap').classList.add('active');
                renderAPMode();
            } else {
                document.getElementById('btn-mode-kindy').classList.add('active');
                renderKindyMode();
            }
        }

        function renderAPMode() {
            document.getElementById('label-book-ap').classList.remove('hidden');
            document.getElementById('label-book-kindy').classList.add('hidden');
            document.getElementById('group-ph-ap').classList.remove('hidden');
            document.getElementById('group-ph-kindy').classList.add('hidden');
            document.getElementById('label-wr').innerText = "Writing";
            document.getElementById('header-quiz').innerText = "Quiz/ Test for Next Time ä¸‹æ¬¡è€ƒè©¦";
            document.getElementById('footer-notice-title').innerText = "è«‹å®¶é•·æé†’å¯¶è²è¦åˆ©ç”¨é»è®€ç­†åšè¤‡ç¿’å“¦ï¼";
            document.getElementById('footer-list').innerHTML = `
                <li>â˜…è¦æœƒå–®å­—æ‹¼å­—</li>
                <li>â˜…è¦æœƒæ›¸å¯«å¥å­</li>
                <li>â˜…è¦æœƒå›ç­”å•é¡Œ</li>
                <li>â˜…è¦æœƒè®€å¥å­</li>
            `;
        }

        function renderKindyMode() {
            document.getElementById('label-book-ap').classList.add('hidden');
            document.getElementById('label-book-kindy').classList.remove('hidden');
            document.getElementById('group-ph-ap').classList.add('hidden');
            document.getElementById('group-ph-kindy').classList.remove('hidden');
            document.getElementById('label-wr').innerText = "Activity Book";
            document.getElementById('header-quiz').innerText = "Focus Areas éœ€åŠ å¼·ç¯„åœ";
            document.getElementById('footer-notice-title').innerText = "è«‹å®¶é•·å”åŠ©å­©å­åœ¨å®¶ä¸­ï¼Œç”¨é»è®€ç­†è¼•é¬†è½ã€è·Ÿè‘—ç©";
            document.getElementById('footer-list').innerHTML = `
                <li>â˜…å¤šè½</li>
                <li>â˜…æœƒè·Ÿè®€</li>
                <li>â˜…æ•¢é–‹å£èªª</li>
                <li>â˜…å»ºç«‹ç†Ÿæ‚‰æ„Ÿ</li>
            `;
        }

        function fillDate() {
            const now = new Date();
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const m = document.getElementById('month');
            const d = document.getElementById('day');
            const w = document.getElementById('weekday');
            m.value = now.getMonth() + 1;
            d.value = now.getDate();
            w.value = days[now.getDay()];
            m.dispatchEvent(new Event('input'));
            d.dispatchEvent(new Event('input'));
            w.dispatchEvent(new Event('input'));
        }

        // --- å…¨æ–°ç­ç´šç®¡ç†é‚è¼¯ ---
        function initSlotToolbar() {
            const container = document.getElementById('slots-container');
            container.innerHTML = ''; 

            for (let i = 1; i <= TOTAL_SLOTS; i++) {
                const savedName = localStorage.getItem(`cb_slot_name_${i}`) || `ç­ç´š ${i}`;
                
                const card = document.createElement('div');
                card.className = 'slot-card';
                card.id = `slot-card-${i}`;
                
                const inputName = document.createElement('input');
                inputName.type = 'text';
                inputName.className = 'slot-name-input';
                inputName.value = savedName;
                inputName.placeholder = 'è¼¸å…¥ç­ç´šå';
                inputName.oninput = (e) => saveSlotName(i, e.target.value);

                const btnLoad = document.createElement('button');
                btnLoad.className = 'slot-btn';
                btnLoad.innerText = `ğŸ“‚ é–‹å•Ÿ`;
                btnLoad.onclick = () => loadAndActivateSlot(i);

                card.appendChild(inputName);
                card.appendChild(btnLoad);
                container.appendChild(card);
            }
            updateSlotVisuals();
        }

        function saveSlotName(id, name) {
            localStorage.setItem(`cb_slot_name_${id}`, name);
        }

        function updateSlotVisuals() {
            for (let i = 1; i <= TOTAL_SLOTS; i++) {
                const card = document.getElementById(`slot-card-${i}`);
                if (i === activeSlotId) {
                    card.classList.add('active-slot');
                    const currentName = document.querySelector(`#slot-card-${i} .slot-name-input`).value;
                    document.getElementById('btn-main-save').innerText = `ğŸ’¾ å„²å­˜ (ç›®å‰: ${currentName})`;
                } else {
                    card.classList.remove('active-slot');
                }
            }
        }

        function getPageData() {
            const data = {
                mode: currentMode,
                inputs: {},
                selectors: {}
            };
            inputs.forEach(input => {
                const key = input.id || input.getAttribute('data-id');
                if (key) data.inputs[key] = input.value;
            });
            SELECTOR_IDS.forEach(id => {
                const el = document.getElementById(id);
                data.selectors[id] = el ? el.classList.contains('active') : false;
            });
            return data;
        }

        function setPageData(data) {
            setMode(data.mode);
            for (const [key, value] of Object.entries(data.inputs)) {
                const input = document.getElementById(key) || document.querySelector(`[data-id="${key}"]`);
                if (input) {
                    input.value = value;
                    localStorage.setItem('contact_book_v2_' + key, value);
                }
            }
            for (const [id, isActive] of Object.entries(data.selectors)) {
                const el = document.getElementById(id);
                if (el) {
                    if (isActive) el.classList.add('active');
                    else el.classList.remove('active');
                    localStorage.setItem('contact_book_v2_select_' + id, isActive);
                }
            }
        }

        function loadAndActivateSlot(slotId) {
            const json = localStorage.getItem('cb_slot_' + slotId);
            
            if (json) {
                const data = JSON.parse(json);
                setPageData(data);
            } else {
                if(confirm(`é€™æ˜¯ç©ºçš„å„²å­˜æ ¼ï¼Œè¦æ¸…ç©ºç›®å‰ç•«é¢ä¸¦åˆ‡æ›åˆ°é€™å€‹ç­ç´šå—ï¼Ÿ`)) {
                    clearScreenOnly(); 
                } else {
                    return; 
                }
            }

            activeSlotId = slotId;
            localStorage.setItem('cb_last_active_slot', slotId);
            
            const slotName = document.querySelector(`#slot-card-${slotId} .slot-name-input`).value;
            if(slotName) {
                const classInput = document.getElementById('class-name');
                classInput.value = slotName;
                classInput.dispatchEvent(new Event('input'));
            }

            updateSlotVisuals();
        }

        function saveToCurrentSlot() {
            if (!activeSlotId) return;

            const data = getPageData();
            const now = new Date();
            const timeStr = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
            data.timestamp = timeStr;
            data.className = document.getElementById('class-name').value || 'æœªå‘½å';

            localStorage.setItem('cb_slot_' + activeSlotId, JSON.stringify(data));
            
            if (data.className && data.className !== 'æœªå‘½å') {
                const input = document.querySelector(`#slot-card-${activeSlotId} .slot-name-input`);
                if(input) {
                    input.value = data.className;
                    saveSlotName(activeSlotId, data.className);
                }
            }

            alert(`âœ… å·²å„²å­˜è‡³ã€Œç­ç´š ${activeSlotId}ã€ï¼\næ™‚é–“: ${timeStr}`);
            updateSlotVisuals(); 
        }
        
        function clearScreenOnly() {
             inputs.forEach(input => {
                input.value = '';
                const key = input.id || input.getAttribute('data-id');
                if (key) localStorage.removeItem('contact_book_v2_' + key);
            });
            SELECTOR_IDS.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.remove('active');
                localStorage.removeItem('contact_book_v2_select_' + id);
            });
        }

        function clearAll() {
            if(confirm('ç¢ºå®šè¦æ¸…ç©ºç›®å‰ç•«é¢çš„å…§å®¹å—ï¼Ÿ(å·²å„²å­˜çš„ç­ç´šè³‡æ–™ä¸æœƒæ¶ˆå¤±)')) {
                const backupData = getPageData();
                localStorage.setItem('cb_undo_slot', JSON.stringify(backupData));
                document.getElementById('btn-undo').style.display = 'inline-block'; 
                clearScreenOnly();
            }
        }

        function undoClear() {
            const json = localStorage.getItem('cb_undo_slot');
            if(json) {
                const data = JSON.parse(json);
                setPageData(data);
                document.getElementById('btn-undo').style.display = 'none'; 
                alert('âœ… å·²å¾©åŸå‰›æ‰æ¸…ç©ºçš„å…§å®¹ï¼');
            }
        }

        // --- å‚™ä»½èˆ‡é‚„åŸåŠŸèƒ½ (Full Backup & Restore) ---
        function exportData() {
            if(!confirm('ç¢ºå®šè¦ä¸‹è¼‰å…¨ç¶²ç«™å‚™ä»½æª”æ¡ˆå—ï¼Ÿ\n(åŒ…å«æ‰€æœ‰ç­ç´šå­˜æª”ã€è¨­å®šèˆ‡ç•¶å‰ç•«é¢)')) return;

            const backup = {};
            // éæ­·æ‰€æœ‰ localStorage æ‰¾å‡ºç›¸é—œè³‡æ–™
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                // åªå‚™ä»½è·Ÿæœ¬å·¥å…·æœ‰é—œçš„ keyï¼Œé¿å…å‚™ä»½åˆ°åŒå€‹ç¶²åŸŸä¸‹å…¶ä»–ç¶²ç«™çš„è³‡æ–™
                if (key.startsWith('contact_book') || key.startsWith('cb_')) {
                    backup[key] = localStorage.getItem(key);
                }
            }

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backup));
            const downloadAnchorNode = document.createElement('a');
            const dateStr = new Date().toLocaleDateString('zh-TW').replace(/\//g, '-');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `è¯çµ¡ç°¿å…¨å‚™ä»½_${dateStr}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importData(inputElement) {
            const file = inputElement.files[0];
            if (!file) return;

            if(!confirm('âš ï¸ è­¦å‘Šï¼šé‚„åŸå‚™ä»½å°‡æœƒã€Œè¦†è“‹ã€ç›®å‰ç€è¦½å™¨å…§æ‰€æœ‰çš„ç­ç´šç´€éŒ„èˆ‡è¨­å®šï¼\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                inputElement.value = ''; // æ¸…ç©ºé¸æ“‡
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    // 1. æ¸…é™¤èˆŠæœ‰çš„ç›¸é—œè³‡æ–™
                    // ç‚ºäº†å®‰å…¨ï¼Œæˆ‘å€‘åªæ¸…é™¤æœ¬å·¥å…·ç›¸é—œçš„ keyï¼Œä¸å½±éŸ¿åŒç¶²åŸŸå…¶ä»–ç¶²ç«™
                    const keysToRemove = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key.startsWith('contact_book') || key.startsWith('cb_')) {
                            keysToRemove.push(key);
                        }
                    }
                    keysToRemove.forEach(k => localStorage.removeItem(k));

                    // 2. å¯«å…¥å‚™ä»½è³‡æ–™
                    for (const [key, value] of Object.entries(backup)) {
                        localStorage.setItem(key, value);
                    }

                    alert('âœ… é‚„åŸæˆåŠŸï¼é é¢å°‡é‡æ–°æ•´ç†...');
                    location.reload(); // é‡æ–°æ•´ç†ä»¥è¼‰å…¥æ–°è³‡æ–™

                } catch (err) {
                    console.error(err);
                    alert('âŒ é‚„åŸå¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤æˆ–ææ¯€ã€‚');
                }
            };
            reader.readAsText(file);
        }


        // --- åŒ¯å‡ºæ–‡å­—è¨Šæ¯ ---
        function copyText() {
            const className = document.getElementById('class-name').value || '';
            const m = document.getElementById('month').value || '';
            const d = document.getElementById('day').value || '';
            const w = document.getElementById('weekday').value || '';
            
            let bookTitle1 = '';
            if (currentMode === 'AP') {
                const isBj = document.getElementById('sel-bj').classList.contains('active');
                const isClil = document.getElementById('sel-clil').classList.contains('active');
                if(isBj) bookTitle1 += 'Big Jump';
                if(isBj && isClil) bookTitle1 += ' / ';
                if(isClil) bookTitle1 += 'CLIL';
            } else {
                const isSb = document.getElementById('sel-sb').classList.contains('active');
                if(isSb) bookTitle1 = 'Student Book';
                const hasContent = document.querySelector('input[data-id="bj"]').value.trim() !== '';
                if(!bookTitle1 && hasContent) bookTitle1 = 'Student Book'; 
            }

            let bookTitle2 = '';
            if (currentMode === 'AP') {
                const isPh = document.getElementById('sel-ph').classList.contains('active');
                const isBr = document.getElementById('sel-br').classList.contains('active');
                if(isPh) bookTitle2 += 'Phonics';
                if(isPh && isBr) bookTitle2 += ' / ';
                if(isBr) bookTitle2 += 'Better Reader';
                if(!bookTitle2) bookTitle2 = 'Phonics/Better Reader';
            } else {
                bookTitle2 = 'Stem/CLIL';
            }

            const labelWr = document.getElementById('label-wr').innerText;
            const bjVal = document.querySelector('input[data-id="bj"]').value;
            const phVal = document.querySelector('input[data-id="ph"]').value;
            const wrVal = document.querySelector('input[data-id="wr"]').value;
            const otVal = document.querySelector('input[data-id="ot"]').value;
            const hwVal = document.querySelector('textarea[data-id="hw"]').value;
            const qzVal = document.querySelector('textarea[data-id="qz"]').value;

            let text = `ã€è‹±æ–‡ç­èª²ç¨‹é€²åº¦é€šçŸ¥ã€‘\n`;
            if (className) text += `ğŸ« ç­ç´šï¼š${className}\n`;
            text += `ğŸ“… æ—¥æœŸï¼š${m}æœˆ${d}æ—¥ (${w})\n\n`;

            text += `ğŸ“– ä»Šæ—¥èª²ç¨‹ Today's Lesson\n`;
            
            let listIndex = 1;
            if (bookTitle1 || bjVal) text += `${listIndex++}. ${bookTitle1}ï¼š${bjVal}\n`;
            if (phVal) text += `${listIndex++}. ${bookTitle2}ï¼š${phVal}\n`;
            if (wrVal) text += `${listIndex++}. ${labelWr}ï¼š${wrVal}\n`;
            if (otVal) text += `${listIndex++}. Otherï¼š${otVal}\n`;
            
            text += `\nğŸ  å›å®¶ä½œæ¥­ Homework\n`;
            text += hwVal ? `${hwVal}\n` : `(ç„¡)\n`;

            if (currentMode === 'AP') {
                text += `\nğŸ“ ä¸‹æ¬¡è€ƒè©¦ Quiz\n`;
            } else {
                text += `\nğŸ¯ éœ€åŠ å¼·ç¯„åœ Focus Areas\n`;
            }
            text += qzVal ? `${qzVal}\n` : `(ç„¡)\n`;

            text += `\nğŸ”” è€å¸«çš„å°å®åš€ï¼š\n`;
            text += `${document.getElementById('footer-notice-title').innerText}\n`;
            document.querySelectorAll('#footer-list li').forEach(item => {
                text += `${item.innerText}\n`;
            });
            
            navigator.clipboard.writeText(text).then(() => {
                alert('âœ… å…§å®¹å·²è¤‡è£½ï¼');
            }).catch(err => {
                console.error('ç„¡æ³•è¤‡è£½', err);
                alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–æ–‡å­—ã€‚');
            });
        }

        // --- æˆªåœ–ç”Ÿæˆåœ–ç‰‡ ---
        function generateImage(btnElement) {
            const originalText = btnElement.innerText;
            btnElement.innerText = 'â³ è™•ç†ä¸­...';
            btnElement.disabled = true;

            document.fonts.ready.then(() => {
                const source = document.getElementById('capture-area');
                const clone = source.cloneNode(true);
                
                clone.style.position = 'absolute';
                clone.style.top = '-9999px';
                clone.style.left = '-9999px';
                clone.style.width = '250mm'; 
                clone.style.backgroundColor = '#ffffff';
                
                const inputs = clone.querySelectorAll('input, textarea');
                const originalInputs = source.querySelectorAll('input, textarea');

                inputs.forEach((input, index) => {
                    const originalInput = originalInputs[index];
                    const val = originalInput.value;
                    const div = document.createElement('div');
                    
                    div.innerText = val;
                    div.className = 'snapshot-text-div'; 

                    if (originalInput.classList.contains('input-month') || originalInput.classList.contains('input-day')) {
                        div.classList.add('snapshot-date');
                        div.style.width = '80px';
                    } else if (originalInput.classList.contains('input-weekday')) {
                        div.classList.add('snapshot-date');
                        div.style.textAlign = 'left';
                        div.style.paddingLeft = '10px';
                        div.style.width = '180px';
                    } else if (originalInput.classList.contains('input-classname')) {
                        div.classList.add('snapshot-date');
                        div.style.textAlign = 'left';
                        div.style.paddingLeft = '10px';
                        div.style.width = '400px';
                    } else if (originalInput.classList.contains('table-input')) {
                        div.classList.add('snapshot-table-input');
                    } else if (originalInput.classList.contains('homework-area')) {
                        div.classList.add('snapshot-homework');
                    } else if (originalInput.classList.contains('signature-input')) {
                        div.classList.add('snapshot-signature');
                    }

                    input.parentNode.replaceChild(div, input);
                });

                document.body.appendChild(clone);

                html2canvas(clone, {
                    scale: 2, 
                    useCORS: true,
                    backgroundColor: "#ffffff",
                    height: clone.scrollHeight + 20, 
                    windowHeight: clone.scrollHeight + 50
                }).then(canvas => {
                    const link = document.createElement('a');
                    const dateStr = new Date().toLocaleDateString('zh-TW').replace(/\//g, '-');
                    const prefix = currentMode === 'AP' ? 'è¯çµ¡ç°¿_AP_' : 'è¯çµ¡ç°¿_å¹¼å…’_';
                    link.download = `${prefix}${dateStr}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                    link.remove();
                    document.body.removeChild(clone);
                    btnElement.innerText = originalText;
                    btnElement.disabled = false;
                }).catch(err => {
                    console.error(err);
                    alert('ç™¼ç”ŸéŒ¯èª¤ï¼š' + err);
                    if(document.body.contains(clone)) document.body.removeChild(clone);
                    btnElement.innerText = originalText;
                    btnElement.disabled = false;
                });
            });
        }
    </script>
</body>
</html>
